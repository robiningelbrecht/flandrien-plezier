<html>
<head>
    <title>Flandrienplezier</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="icon" type="image/png" href="/logo.png"/>
    <script src="/js/public-google-sheets-parser@latest.js"></script>
    <script src="/js/echarts.min.js"></script>
    <link href="/css/style.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
<nav class="bg-white border-b border-gray-200 px-4 py-2.5 fixed left-0 right-0 top-0 z-1100">
    <div class="flex items-center gap-x-2.5">
        <img src="logo.png" class="rounded-sm h-8" alt="Flandriens Logo">
        <div>
            <div class="text-lg md:text-2xl font-semibold whitespace-nowrap">
                Flandrienplezier
            </div>
            <div class="text-sm font-normal leading-3 whitespace-nowrap">Zijn we d'r al?</div>
        </div>
    </div>
</nav>
<main class="p-4 h-auto min-h-screen pt-20 text-gray-900">
    <div class="p-4 mb-4 bg-white border border-gray-200 rounded-lg shadow-xs">
        <h2 class="text-lg font-semibold mb-4">Challenge 2025 - We zijn der nog nie &#129402;</h2>
        <div class="flex items-center gap-x-2">
            <svg viewBox="0 0 1024 1024" class="w-[50px]" xmlns="http://www.w3.org/2000/svg" fill="#000000">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <path d="M897.9 369.2H205c-33.8 0-61.4-27.6-61.4-61.4s27.6-61.4 61.4-61.4h692.9c33.8 0 61.4 27.6 61.4 61.4s-27.6 61.4-61.4 61.4z"
                          fill="#FFB89A"></path>
                    <path d="M807 171H703.3c-16.6 0-30 13.4-30 30s13.4 30 30 30H807c31.6 0 57.4 24 57.4 53.4v42.3H125.2v-42.3c0-29.5 25.7-53.4 57.4-53.4H293c16.6 0 30-13.4 30-30s-13.4-30-30-30H182.5c-64.7 0-117.4 50.9-117.4 113.4v527.7c0 62.5 52.7 113.4 117.4 113.4H807c64.7 0 117.4-50.9 117.4-113.4V284.5c0-62.6-52.7-113.5-117.4-113.5z m0 694.6H182.5c-31.6 0-57.4-24-57.4-53.4V386.8h739.2v425.4c0.1 29.5-25.7 53.4-57.3 53.4z"
                          fill="#45484C"></path>
                    <path d="M447.6 217.1c-12.4-6.1-27-2.8-35.7 7.1-2.2-6.7-4-16.2-4-28.1 0-13 2.2-23 4.6-29.8 9.5 8.1 23.5 9.6 34.9 2.8 14.2-8.5 18.8-27 10.3-41.2-15.5-25.9-35.9-29.7-46.6-29.7-36.6 0-63.1 41.2-63.1 97.8s26.4 98 63 98c20.6 0 39-13.4 50.4-36.7 7.3-14.9 1.1-32.9-13.8-40.2zM635.9 218.5c-12.4-6.1-27-2.8-35.7 7.1-2.2-6.7-4-16.2-4-28.1 0-13 2.2-23 4.6-29.8 9.5 8.1 23.5 9.6 34.9 2.8 14.2-8.5 18.8-27 10.3-41.2-15.5-25.9-35.9-29.7-46.6-29.7-36.6 0-63.1 41.2-63.1 97.8s26.5 97.8 63.1 97.8c20.6 0 39-13.4 50.4-36.7 7.1-14.7 0.9-32.7-13.9-40z"
                          fill="#45484C"></path>
                    <path d="M700.2 514.5H200.5c-16.6 0-30 13.4-30 30s13.4 30 30 30h499.7c16.6 0 30-13.4 30-30s-13.5-30-30-30zM668.4 689.8h-74c-16.6 0-30 13.4-30 30s13.4 30 30 30h74c16.6 0 30-13.4 30-30s-13.4-30-30-30zM479.3 689.8H200.5c-16.6 0-30 13.4-30 30s13.4 30 30 30h278.8c16.6 0 30-13.4 30-30s-13.4-30-30-30z"
                          fill="#33CC99"></path>
                </g>
            </svg>
            <span>Dagen ver in 2025: <strong class="day-of-the-year">...</strong></span>
        </div>
        <div class="flex items-center gap-x-2">
            <svg viewBox="0 0 1024 1024" class="w-[50px]" xmlns="http://www.w3.org/2000/svg" fill="#000000">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <path d="M840.5 798.2L662.3 599.5l-151 173.7-173.7-173.7-167.7 201c-21 30.4 0.9 71.8 37.9 71.6l594.7-3.3c36.2-0.1 57.8-40.3 38-70.6z"
                          fill="#FFB89A"></path>
                    <path d="M741.6 647.3l-52.3-47.7c-12.2-11.2-31.2-10.3-42.4 1.9s-10.3 31.2 1.9 42.4l52.3 47.7c5.8 5.3 13 7.8 20.2 7.8 8.1 0 16.2-3.3 22.2-9.8 11.2-12.1 10.3-31.1-1.9-42.3zM631.2 546.5c-12.4-11-31.4-9.8-42.3 2.6l-98.8 111.7-171-165.7L87.9 724.7c-11.8 11.7-11.8 30.7-0.1 42.4 5.9 5.9 13.6 8.9 21.3 8.9 7.6 0 15.3-2.9 21.1-8.7l189.4-188.1 173.8 168.5L633.8 589c11-12.5 9.8-31.5-2.6-42.5z"
                          fill="#33CC99"></path>
                    <path d="M721.3 342.8m-35.1 0a35.1 35.1 0 1 0 70.2 0 35.1 35.1 0 1 0-70.2 0Z" fill="#33CC99"></path>
                    <path d="M743.2 175.1H191.6c-70.6 0-128.3 57.7-128.3 128.3v499.2c0 70.6 57.7 128.3 128.3 128.3h551.5c70.6 0 128.3-57.7 128.3-128.3V303.5c0.1-70.6-57.7-128.4-128.2-128.4z m68.3 627.6c0 18.1-7.1 35.2-20.1 48.2-13 13-30.1 20.1-48.2 20.1H191.6c-18.1 0-35.2-7.1-48.2-20.1-13-13-20.1-30.1-20.1-48.2V303.5c0-18.1 7.1-35.2 20.1-48.2 13-13 30.1-20.1 48.2-20.1h551.5c18.1 0 35.2 7.1 48.2 20.1 13 13 20.1 30.1 20.1 48.2v499.2z"
                          fill="#45484C"></path>
                    <path d="M799.7 90.9H237.2c-16.6 0-30 13.4-30 30s13.4 30 30 30h562.4c26.1 0 50.8 10.3 69.4 28.9 18.6 18.6 28.9 43.3 28.9 69.4v482.4c0 16.6 13.4 30 30 30s30-13.4 30-30V249.2C958 161.9 887 90.9 799.7 90.9z"
                          fill="#45484C"></path>
                </g>
            </svg>
            <span>Target vandaag: <strong class="todays-target">...</strong></span>
        </div>
        <div class="grid grid-cols-1 gap-4 mt-4">
            <div class="overflow-x-auto">
                <div class="challenge-2025-overall-chart w-full min-w-[600px] h-[400px] text-sm flex items-center justify-center">
                    Loading...
                </div>
            </div>
            <div class="overflow-x-auto">
                <div class="challenge-2025-monthly-chart w-full min-w-[600px] h-[400px] text-sm flex items-center justify-center">
                    Loading...
                </div>
            </div>
        </div>
    </div>
    <div class="p-4 mb-4 bg-white border border-gray-200 rounded-lg shadow-xs">
        <h2 class="text-lg font-semibold mb-4">Challenge 2024 - We zijn der &#129395;</h2>
        <div class="overflow-x-auto">
            <div class="challenge-2024-chart w-full min-w-[600px] h-[400px] text-sm flex items-center justify-center">
                Loading...
            </div>
        </div>
    </div>
</main>
<script>
    const charts = [];
    const spreadsheetId = '1KSP-WQZOKonBoQJ5Ye16wstMFdXA9BW_goE8Qcx1ERg';

    const timeToDecimal = (t) => {
        const arr = t.split(':');
        const dec = parseInt((arr[1] / 6) * 10, 10);

        return parseFloat(parseInt(arr[0], 10) + '.' + (dec < 10 ? '0' : '') + dec);
    }

    const render2025Challenge = (colors) => {
        const now = new Date();
        const start = new Date(now.getFullYear(), 0, 0);
        const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
        const oneDay = 1000 * 60 * 60 * 24;
        const day = Math.floor(diff / oneDay);

        document.querySelector('.day-of-the-year').innerText = day;
        document.querySelector('.todays-target').innerText = Math.ceil(2500 / 365 * day) + 'h';

        const parser = new PublicGoogleSheetsParser(spreadsheetId, {
            sheetName: '2025',
            useFormat: true
        });

        parser.parse().then(data => {
            const chart2025Overall = echarts.init(document.querySelector('.challenge-2025-overall-chart'));
            const seriesOverall = [];

            Object.keys(data[0]).filter(key => !key.includes('Month') && !key.includes('month') && !key.includes('%')).forEach(seriesName => {
                seriesOverall.push({
                    name: seriesName,
                    type: 'line',
                    itemStyle: {
                        color: colors[seriesName],
                    },
                    data: data.map(item => {
                        const timeInDecimal = item[seriesName] ? timeToDecimal(item[seriesName]) : null;
                        return timeInDecimal > 0 ? timeInDecimal : null
                    })
                });
            });

            chart2025Overall.setOption({
                title: {
                    text: 'Summary',
                },
                grid: {
                    containLabel: true,
                    top: '10%',
                    bottom: '2%',
                    left: '0%',
                    right: '170px',
                },
                tooltip: {
                    trigger: 'axis',
                    valueFormatter: (value) => value + 'h'
                },
                legend: {
                    orient: 'vertical',
                    right: 'right',

                },
                xAxis: {
                    data: data.map(item => item['Month']),
                    axisTick: {
                        show: false
                    }
                },
                yAxis: {
                    axisLabel: {
                        formatter: function (value, index) {
                            return value + 'h';
                        }
                    }
                },
                series: seriesOverall
            });
            charts.push(chart2025Overall);

            const seriesMonthly = [];
            const chart2025monthly = echarts.init(document.querySelector('.challenge-2025-monthly-chart'));
            Object.keys(data[0]).filter(key => key.includes('/ month')).forEach(seriesName => {
                const seriesLabel = seriesName.replace(' / month', '');
                const isGoalSeries = seriesLabel === 'Goal';

                console.log(data);

                seriesMonthly.push({
                    name: seriesLabel,
                    type: isGoalSeries ? 'line' : 'bar',
                    stack: isGoalSeries ? null : 'total',
                    label: {
                        show: isGoalSeries,
                        formatter: (params) => {
                            const percentageCompleted = data[params.dataIndex]['Completed month %'].replace('%', '');
                            if (percentageCompleted <= 0) {
                                return '';
                            }

                            const delta = (percentageCompleted - 100);
                            return '{' + (delta >= 0 ? 'green' : 'red') + '|' + (percentageCompleted - 100).toFixed(2) + '%}';
                        },
                        rich: {
                            red: {
                                color: '#EE6766',
                            },
                            green: {
                                color: '#3AA272',
                            },
                        }
                    },
                    data: data.map(item => {
                        const timeInDecimal = item[seriesName] ? timeToDecimal(item[seriesName]) : null;
                        return timeInDecimal > 0 ? timeInDecimal : null
                    }),
                    itemStyle: {
                        color: colors[seriesLabel],
                    },
                });
            });

            chart2025monthly.setOption({
                title: {
                    text: 'Monthly stats',
                },
                grid: {
                    containLabel: true,
                    top: '10%',
                    bottom: '2%',
                    left: '0%',
                    right: '170px',
                },
                tooltip: {
                    trigger: 'axis',
                    valueFormatter: (value) => value + 'h'
                },
                legend: {
                    orient: 'vertical',
                    right: 'right',

                },
                xAxis: {
                    data: data.map(item => item['Month']),
                    axisTick: {
                        show: false
                    }
                },
                yAxis: {
                    axisLabel: {
                        formatter: function (value, index) {
                            return value + 'h';
                        }
                    }
                },
                series: seriesMonthly
            });

            charts.push(chart2025monthly);
        });
    };

    const render2024Challenge = (colors) => {
        const parser = new PublicGoogleSheetsParser(spreadsheetId, {
            sheetName: '2024',
            useFormat: true
        });

        parser.parse().then(data => {
            const chart2024 = echarts.init(document.querySelector('.challenge-2024-chart'));
            const series = [];

            Object.keys(data[0]).filter(key => key !== 'Month').forEach(seriesName => {
                series.push({
                    name: seriesName,
                    type: 'line',
                    data: data.map(item => item[seriesName]),
                    itemStyle: {
                        color: colors[seriesName],
                    },
                });
            });
            chart2024.setOption({
                grid: {
                    containLabel: true,
                    top: '3%',
                    bottom: '2%',
                    left: '0%',
                    right: '170px',
                },
                tooltip: {
                    trigger: 'axis',
                    valueFormatter: (value) => value + 'km'
                },
                legend: {
                    orient: 'vertical',
                    right: 'right',

                },
                xAxis: {
                    data: data.map(item => item['Month']),
                    axisTick: {
                        show: false
                    }
                },
                yAxis: {
                    axisLabel: {
                        formatter: function (value, index) {
                            return value + 'km';
                        }
                    }
                },
                series: series
            });
            charts.push(chart2024);
        });
    };

    const parser = new PublicGoogleSheetsParser(spreadsheetId, {
        sheetName: 'Kleurtjes',
        useFormat: true
    });

    parser.parse().then(colors => {
        const formattedColors = [];

        colors.forEach(color => {
            formattedColors[color['Wat']] = color['Kleur'];
        });
        render2025Challenge(formattedColors);
        render2024Challenge(formattedColors);
    });

    window.addEventListener('resize', function () {
        charts.forEach(chart => chart.resize());
    });
</script>
</body>
</html>